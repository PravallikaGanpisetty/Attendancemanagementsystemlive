require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const authRoutes = require('./routes/auth');
const attendanceRoutes = require('./routes/attendance');
const path = require('path');

const app = express();
app.use(cors({
  origin: ['http://localhost:5177', 'http://localhost:5173', /^http:\/\/localhost:\d+$/],
  credentials: true,
}));
app.use(express.json());

app.use('/api/auth', authRoutes);
app.use('/api/attendance', attendanceRoutes);

app.get('/api/health', (_req, res) => {
  res.json({ status: 'ok' });
});

// Global error handler - must be last
app.use((err, req, res, next) => {
  console.error('üî• Unhandled Server Error:', err);
  console.error('Error Stack:', err.stack);
  res.status(err.status || 500).json({ 
    message: err.message || 'Internal server error',
    error: process.env.NODE_ENV === 'development' ? err.stack : undefined
  });
});

const MONGO = process.env.MONGO_URI || 'mongodb://localhost:27017/Attendancemsd';
mongoose.connect(MONGO)
  .then(()=> {
    console.log('‚úÖ Mongo connected successfully');
    const PORT = process.env.PORT || 5000;
    // Optionally serve built frontend for production when enabled
    if (process.env.SERVE_FRONTEND === 'true') {
      const distPath = path.join(__dirname, '..', 'frontend', 'dist');
      app.use(express.static(distPath));
      app.get('*', (req, res) => {
        res.sendFile(path.join(distPath, 'index.html'));
      });
      console.log('Serving frontend from', distPath);
    }
    const server = app.listen(PORT, ()=> {
      console.log(`üöÄ Server running on http://localhost:${PORT}`);
      console.log(`üì° API endpoints available at http://localhost:${PORT}/api`);
    });
    server.on('error', (err) => {
      if (err && err.code === 'EADDRINUSE') {
        console.error(`Port ${PORT} is already in use. Free it or set PORT env to a free port.`);
        console.error('On Windows PowerShell:');
        console.error('  netstat -ano | findstr :%PORT%');
        console.error('  taskkill /PID <pid> /F');
        process.exit(1);
      }
      throw err;
    });
  })
  .catch(err => {
    console.error('‚ùå Mongo connection error:', err.message);
    console.error('üí° Check your MONGO_URI in .env file');
    console.error('üí° Make sure MongoDB Atlas IP whitelist includes your IP (or 0.0.0.0/0 for all)');
    process.exit(1);
  });
